# Camunda BPM Prometheus Metrics Process Engine Plugin


High level prometheus client for Camunda BPM, implemented as a Camunda Process Engine Plugin.
Clinet provides a series of simple metric classes that can be activated from any scripting or java class within a Camunda execution.


WIP

Currently functional, but still testing


![basic 1](./docs/images/basic1.png)

# Groovy script Examples:

```groovy
import io.digitalstate.camunda.prometheus.collectors.SimpleGaugeMetric;

def openCases = new SimpleGaugeMetric('open_cases', 'Number of Open Cases, labeled by Case Type', ['type'])

openCases.increment(['standard'])
```

```groovy
import io.digitalstate.camunda.prometheus.collectors.SimpleHistogramMetric

def httpRequest = new SimpleHistogramMetric('legacy_system_123_request', 'Connection duration time, labeled by HTTP Method', null, ['method'])

httpRequest.startTimer(['POST'])

sleep(Math.abs(new Random().nextInt() % 5000) + 650) // Simulates a delay

httpRequest.observeDuration()

```

```groovy
import io.digitalstate.camunda.prometheus.collectors.SimpleGaugeMetric

def money = new SimpleGaugeMetric('money_collected', 'dollar values collected, labeled by form of payment', ['payment_form'])

def amount = Math.abs(new Random().nextDouble() % 284.03) + 23.54 // Random dollar value
money.increment(amount, ['credit-card'])
```

```groovy
import io.digitalstate.camunda.prometheus.collectors.SimpleGaugeMetric

def openCases = new SimpleGaugeMetric('open_cases')

openCases.decrement(['standard'])

def closedCases = new SimpleGaugeMetric('closed_cases', 'Number of Open Cases, labeled by Case Type', ['type'])
closedCases.increment(['standard'])
```

# Metrics Classes

Simple but reusable metrics are provided for ease of use by BPMN process builders.

1. SimpleGaugeMetric (io.digitalstate.camunda.prometheus.collectors.SimpleGaugeMetric)
1. SimpleCounterMetric (io.digitalstate.camunda.prometheus.collectors.SimpleCounterMetric)
1. SimpleHistogramMetric (io.digitalstate.camunda.prometheus.collectors.SimpleHistorgramMetric)
1. SimpleSummaryMetric (io.digitalstate.camunda.prometheus.collectors.SimpleSummaryMetric)

See the Test folder for further usage, and see the metric classes.  They are generally simplifications over the existing metrics API.  They are designed to remove "extras" and simplify usage.

# Namspace

the `camunda` namespace is given to all metrics generated by the Simple Metric classes.

# Prometheus Collector Registry

The Default registry is used.

# Labels

Labels are supported and are generally implemented as a optional parameter in the method.  See examples above.


# Plugin Configuration

```xml
<!-- engine plugins -->
<property name="processEnginePlugins">
    <list>
        ...
        <bean id="prometheusPlugin" class="io.digitalstate.camunda.prometheus.PrometheusProcessMetricsProcessEnginePlugin">
            <property name="port" value="9999" />
        </bean>
        ...
    </list>
</property>
```

The port is the port that the HTTP Server that Prometheus will use to access the metrics.


# Prometheus Setup:

You can use a docker container such as:

https://github.com/vegasbrianc/prometheus

and in the /prometheus/prometheus.yml file, add the following in the `scrape_configs` section

```yml
  - job_name: 'camunda'
    scrape_interval: 5s
    static_configs:
        - targets: ['localhost:9999']
```

where `localhost` is the domain of the Camunda server and `9999` is the port configured in the process engine plugin configuration xml.



# Todo:

1. Add try/catch to all registration and modifications and log errors rather than throwing error.
1. Add Better Prometheus usage docs
1. Add screenshots of examples of dashboards
1. Add further docs on the Simple Metric classes
1. :exclamation: Add Camunda Startup logic to perform Engine queries for pre-population of initial values/current values of metrics.  Example: If a count or gauge is running that is tracking a "number of dollars collected", if camunda is restarted, we want to recalculate this value on startup so we are not restarting at zero.